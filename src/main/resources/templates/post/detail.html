<!DOCTYPE html>
<html th:replace="~{layout :: layout(~{::title}, ~{::content}, ~{::scripts})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시글 상세</title>
</head>
<body>
    <div th:fragment="content">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card p-4">
                    <div class="border-bottom pb-3 mb-3">
                        <h2 id="post-title">로딩중...</h2>
                        <div class="text-muted d-flex justify-content-between">
                            <span id="post-author">작성자: -</span>
                            <span id="post-date">날짜: -</span>
                        </div>
                    </div>

                    <div class="mb-5" style="min-height: 200px; white-space: pre-wrap;" id="post-content">
                        내용을 불러오는 중입니다...
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/" class="btn btn-secondary">목록으로</a>
                        
                        <div id="owner-btns" style="display: none;">
                            <button onclick="deletePost()" class="btn btn-danger">삭제</button>
                            <button onclick="moveEditPage()" class="btn btn-warning">수정</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:fragment="scripts">
    <script>
        // URL에서 글 ID 추출 (예: /post/1 -> 1)
        const pathSegments = window.location.pathname.split("/");
        const postId = pathSegments[pathSegments.length - 1];

        document.addEventListener("DOMContentLoaded", function() {
            fetchPostDetail();
        });

        function fetchPostDetail() {
            fetch(`/api/posts/${postId}`) // 상세 조회 API 호출
            .then(response => {
                if (!response.ok) throw new Error("게시글을 찾을 수 없습니다.");
                return response.json();
            })
            .then(result => {
                const post = result.data;
                
                // 1. 화면에 데이터 채우기
                document.getElementById('post-title').innerText = post.title;
                document.getElementById('post-author').innerText = "작성자: " + post.author;
                document.getElementById('post-content').innerText = post.content;
                
                if(post.updatedAt) {
                    // 날짜 포맷 예쁘게 (YYYY. MM. DD. 오전/오후 HH:MM)
                    document.getElementById('post-date').innerText = "날짜: " + new Date(post.updatedAt).toLocaleString();
                }

                // 2. 권한 체크 (내 글이면 수정/삭제 버튼 보이기)
                // 로컬 스토리지의 닉네임과 게시글 작성자 닉네임 비교
                const myNickname = localStorage.getItem('nickname');
                if (myNickname && myNickname === post.author) {
                    document.getElementById('owner-btns').style.display = 'block';
                }
            })
            .catch(err => {
                alert(err.message);
                window.location.href = "/";
            });
        }

        // 게시글 삭제 함수
        function deletePost() {
            if (!confirm("정말 이 글을 삭제하시겠습니까?")) return;

            fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: getAuthHeaders() // 토큰 포함
            })
            .then(response => {
                if (response.ok) {
                    alert("삭제되었습니다.");
                    window.location.href = "/";
                } else {
                    response.json().then(res => alert("삭제 실패: " + res.error.message));
                }
            })
            .catch(err => alert("서버 통신 오류"));
        }

        // 수정 페이지 이동 함수
        function moveEditPage() {
            window.location.href = `/post/edit/${postId}`;
        }
    </script>
    </th:block>
</body>
</html>